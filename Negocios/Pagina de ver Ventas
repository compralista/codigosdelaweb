<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard de Ventas | Ponete en Marcha</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- VARIABLES & RESET --- */
    :root {
      --primary: #4F46E5;
      --bg-body: #F3F4F6;
      --bg-card: #FFFFFF;
      --text-main: #1F2937;
      --text-muted: #6B7280;
      --border: #E5E7EB;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    body.dark {
      --primary: #6366f1;
      --bg-body: #111827;
      --bg-card: #1F2937;
      --text-main: #F9FAFB;
      --text-muted: #9CA3AF;
      --border: #374151;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-body); color: var(--text-main); transition: background 0.3s, color 0.3s; padding: 20px; }

    /* --- LAYOUT --- */
    .dashboard-container { max-width: 1400px; margin: 0 auto; }
    
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
    h1 { font-size: 1.5rem; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    h1 i { color: var(--primary); }

    /* --- TARJETAS DE RESUMEN (KPIs) --- */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .kpi-card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
    .kpi-icon { width: 50px; height: 50px; border-radius: 10px; background: #EEF2FF; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--primary); }
    body.dark .kpi-icon { background: #3730a3; color: #fff; }
    .kpi-info h3 { margin: 0; font-size: 0.85rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-info p { margin: 5px 0 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main); }

    /* --- CONTROLES Y FILTROS --- */
    .controls-panel { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 20px; }
    .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    
    label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: var(--text-muted); }
    input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); outline: none; transition: border 0.2s; font-family: inherit; }
    input:focus, select:focus { border-color: var(--primary); ring: 2px solid var(--primary); }

    .actions-row { display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; border-top: 1px solid var(--border); padding-top: 15px; }

    button { padding: 10px 16px; border-radius: 8px; border: none; font-weight: 500; cursor: pointer; transition: transform 0.1s, opacity 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    button:active { transform: scale(0.98); }
    
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
    .btn-secondary:hover { background: var(--border); }
    .btn-xs { padding: 4px 10px; font-size: 0.75rem; border-radius: 4px; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-muted); margin-top: 5px; }
    .btn-xs:hover { color: var(--primary); border-color: var(--primary); }
    
    /* --- TABLA --- */
    .table-container { background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
    .table-responsive { overflow-x: auto; }
    
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { background: var(--bg-body); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; color: var(--text-muted); user-select: none; }
    tr:hover { background-color: rgba(0,0,0,0.02); }
    body.dark tr:hover { background-color: rgba(255,255,255,0.02); }
    
    .money { font-family: 'Courier New', monospace; font-weight: 700; color: var(--text-main); }
    
    /* Estilos especificos para detalle */
    .col-detalle { 
        white-space: normal; 
        min-width: 250px; 
        max-width: 350px; 
    }
    .detalle-texto {
        display: -webkit-box;
        -webkit-line-clamp: 2; /* Muestra maximo 2 lineas */
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    /* Botones de tabla */
    .btn-wa { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; text-decoration: none; font-size: 1rem; transition: background 0.2s; }
    .btn-wa-client { background: #DCFCE7; color: #166534; } 
    .btn-wa-client:hover { background: #BBF7D0; }
    .btn-wa-support { background: #FEF3C7; color: #92400E; } 
    .btn-wa-support:hover { background: #FDE68A; }

    /* Paginación */
    #pager { padding: 15px; display: flex; justify-content: center; gap: 5px; }
    .page-btn { width: 30px; height: 30px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); background: var(--bg-card); }
    .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* Loader */
    #loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.8); z-index: 1000;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
        color: var(--primary); font-weight: 600;
        backdrop-filter: blur(2px);
    }
    body.dark #loading-overlay { background: rgba(0,0,0,0.8); }

    /* --- MODAL (NUEVO) --- */
    .modal-overlay {
        display: none; 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 2000;
        justify-content: center; align-items: center;
        backdrop-filter: blur(3px);
    }
    .modal-content {
        background: var(--bg-card);
        width: 90%; max-width: 500px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        display: flex; flex-direction: column;
        max-height: 80vh;
        animation: slideIn 0.2s ease-out;
    }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-weight: 600; font-size: 1.1rem; }
    .modal-close { cursor: pointer; font-size: 1.2rem; color: var(--text-muted); }
    /* Ajuste aqui para el cuerpo del modal */
    .modal-body { padding: 0; overflow-y: auto; font-size: 0.95rem; } 
    .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); text-align: right; }
    
    /* Estilo para items de la lista modal */
    .modal-item { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; gap: 10px; }
    .modal-item:last-child { border-bottom: none; }
    .modal-item i { color: var(--primary); margin-top: 3px; font-size: 0.8rem; }

    @media (max-width: 768px) {
        .filters-grid { grid-template-columns: 1fr; }
        .actions-row { justify-content: stretch; }
        button { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <i class="fas fa-circle-notch fa-spin fa-3x"></i>
    <p style="margin-top:15px">Sincronizando ventas...</p>
  </div>

  <div class="dashboard-container">
    
    <header>
      <h1><i class="fas fa-chart-line"></i> Registro de Ventas</h1>
      <div>
         <button id="themeToggle" class="btn-secondary"><i class="fas fa-moon"></i> Tema</button>
      </div>
    </header>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-wallet"></i></div>
            <div class="kpi-info">
                <h3>Total Filtrado</h3>
                <p id="kpi-total">$0.00</p>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-shopping-bag"></i></div>
            <div class="kpi-info">
                <h3>Ventas</h3>
                <p id="kpi-count">0</p>
            </div>
        </div>
        <div class="kpi-card">
             <div class="kpi-icon"><i class="fas fa-clock"></i></div>
             <div class="kpi-info">
                 <h3>Última Venta</h3>
                 <p id="kpi-last" style="font-size:1rem; font-weight:500">-</p>
             </div>
        </div>
    </div>

    <div class="controls-panel">
      <div class="filters-grid">
        <div>
            <label>Búsqueda General</label>
            <input id="search" placeholder="Nombre cliente o producto..." />
        </div>
        <div>
            <label>ID Venta</label>
            <input id="filterID" placeholder="Ej: 1024" />
        </div>
        <div>
            <label>Desde</label>
            <input id="from" type="date" />
        </div>
        <div>
            <label>Hasta</label>
            <input id="to" type="date" />
        </div>
      </div>
      
      <div class="actions-row">
         <select id="perPage" style="width: auto;">
             <option value="10">10 por pág</option>
             <option value="25">25 por pág</option>
             <option value="50">50 por pág</option>
         </select>
         <button id="refresh" class="btn-secondary"><i class="fas fa-sync-alt"></i> Actualizar</button>
         <button id="export" class="btn-primary"><i class="fas fa-file-csv"></i> Exportar CSV</button>
      </div>
    </div>

    <div class="table-container">
        <div class="table-responsive">
            <table id="ventasTable">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Detalle</th>
                    <th>Total</th>
                    <th style="text-align:center">Acciones</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <nav id="pager"></nav>
        <div id="no-results" style="padding:40px; text-align:center; color:var(--text-muted); display:none;">
            <i class="fas fa-search fa-2x" style="margin-bottom:10px; opacity:0.5"></i>
            <p>No se encontraron ventas con estos filtros.</p>
        </div>
    </div>

  </div>

  <div id="detailModal" class="modal-overlay">
      <div class="modal-content">
          <div class="modal-header">
              <div class="modal-title">Detalle Completo <span id="modalId" style="color:var(--primary); font-size:0.9em; margin-left:5px"></span></div>
              <div class="modal-close" onclick="closeDetail()"><i class="fas fa-times"></i></div>
          </div>
          <div class="modal-body" id="modalText"></div>
          <div class="modal-footer">
              <button class="btn-primary" onclick="closeDetail()">Cerrar</button>
          </div>
      </div>
  </div>

  <script>
    // ===== CONFIGURACIÓN =====
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdZ1Qsrzqopm4g4s0NZJK7AKm6plFVoKvpWdymZ-MOIAktQCWsa6Ki4te4UqJUfnfK/exec';
    const telefonoNegocio = '5492664212722';
    const nombreNegocio = "El Fresquito";
    // =========================

    let rawData = [];
    let filteredData = [];
    let currentPage = 1;
    let itemsPerPage = 10;

    // Elementos DOM
    const el = {
        tableBody: document.querySelector('#ventasTable tbody'),
        loading: document.getElementById('loading-overlay'),
        pager: document.getElementById('pager'),
        inputs: {
            search: document.getElementById('search'),
            id: document.getElementById('filterID'),
            from: document.getElementById('from'),
            to: document.getElementById('to'),
            perPage: document.getElementById('perPage')
        },
        kpi: {
            total: document.getElementById('kpi-total'),
            count: document.getElementById('kpi-count'),
            last: document.getElementById('kpi-last')
        },
        noResults: document.getElementById('no-results'),
        modal: {
            overlay: document.getElementById('detailModal'),
            text: document.getElementById('modalText'),
            id: document.getElementById('modalId')
        }
    };

    // --- FUNCIONES DE FORMATO ---
    const formatMoney = (amount) => {
        return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount);
    };

    const formatDate = (dateObj) => {
        if(!dateObj) return '-';
        return dateObj.toLocaleString('es-AR', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    };

    // --- MENSAJES WHATSAPP ---
    function mensajeWhatsApp(venta){
      return `Hola, necesito reportar un tema con la venta #${venta.id}.
Cliente: ${venta.nombre_cliente}
Total: ${formatMoney(venta.total)}
Detalle: ${venta.detalle_compra}
Negocio: ${nombreNegocio}`;
    }

    function mensajeCliente(venta){
      return `Hola ${venta.nombre_cliente}, te escribimos de ${nombreNegocio}. 
Recibimos tu pedido #${venta.id} (${venta.detalle_compra}) por un total de ${formatMoney(venta.total)}. 
Te avisaremos cuando esté listo. ¡Gracias!`;
    }

    // --- LÓGICA DE DATOS ---
    async function fetchSheet(){
      // Si el loader ya no está visible (ej: autorefresh), no mostrarlo para no molestar
      // pero si es la primera carga, sí.
      if(!rawData.length) el.loading.style.display = 'flex';
      
      try{
        const res = await fetch(APP_SCRIPT_URL);
        const json = await res.json();
        const rows = (json.rows||[]).map(normalizeRow);
        
        // Ordenar por fecha descendente (más nuevo primero)
        rawData = rows.sort((a,b) => b._date - a._date);
        
        applyFilters();
        updateKPIs(rawData); // KPI iniciales con todo
      }catch(err){
        console.error(err);
      }finally{
        el.loading.style.display = 'none';
      }
    }

    function normalizeRow(r){
      const mapKey = k=>k?k.toString().toLowerCase().replace(/\s+/g,'_'):'';  
      const norm = {};
      for(const k in r) norm[mapKey(k)] = r[k];

      const out = {};
      out.id = norm.id||norm['#']||'';
      out.fecha_hora = norm.fecha_hora||norm.fecha||'';
      out.total = parseFloat((norm.total||'0').toString().replace("$","").replace(".","").replace(",",".")); 
      // NOTA: Ajusta el replace anterior si tus numeros vienen como "1.000,00" o "1,000.00"
      // El ejemplo anterior asume formato europeo/latam "1.000,00" -> quita punto miles, cambia coma a punto.
      
      out.detalle_compra = norm.detalle_compra||norm.detalle||'';
      out.nombre_cliente = norm.nombre_cliente||norm.cliente||'';
      out.celular_cliente = norm.celular_cliente||norm.celular||'';
      out._date = new Date(out.fecha_hora);
      return out;
    }

    // --- FILTRADO ---
    function applyFilters(){
        const search = el.inputs.search.value.toLowerCase();
        const searchId = el.inputs.id.value.toString();
        const dateFrom = el.inputs.from.value ? new Date(el.inputs.from.value) : null;
        const dateTo = el.inputs.to.value ? new Date(el.inputs.to.value) : null;
        
        if(dateTo) dateTo.setHours(23,59,59);

        filteredData = rawData.filter(row => {
            const matchesText = row.nombre_cliente.toLowerCase().includes(search) || 
                                row.detalle_compra.toLowerCase().includes(search);
            const matchesId = searchId === '' || row.id.toString().includes(searchId);
            
            let matchesDate = true;
            if(dateFrom && row._date < dateFrom) matchesDate = false;
            if(dateTo && row._date > dateTo) matchesDate = false;

            return matchesText && matchesId && matchesDate;
        });

        currentPage = 1;
        updateKPIs(filteredData);
        renderTable();
    }

    function updateKPIs(data){
        const total = data.reduce((sum, row) => sum + (isNaN(row.total) ? 0 : row.total), 0);
        el.kpi.total.textContent = formatMoney(total);
        el.kpi.count.textContent = data.length;
        if(data.length > 0){
            el.kpi.last.textContent = formatDate(data[0]._date); 
        } else {
            el.kpi.last.textContent = "-";
        }
    }

    // --- RENDERIZADO ---
    function renderTable(){
        el.tableBody.innerHTML = '';
        
        if(filteredData.length === 0){
            el.noResults.style.display = 'block';
            el.pager.innerHTML = '';
            return;
        }
        el.noResults.style.display = 'none';

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageData = filteredData.slice(start, end);

        pageData.forEach(row => {
            const tr = document.createElement('tr');
            
            // Lógica para detalle largo
            let detalleContent = `<div class="detalle-texto">${row.detalle_compra}</div>`;
            if(row.detalle_compra.length > 50){
                detalleContent += `<button class="btn-xs" onclick="openDetail('${row.id}')">Ver todo</button>`;
            }

            tr.innerHTML = `
                <td><span style="font-weight:600; color:var(--primary)">#${row.id}</span></td>
                <td style="font-size:0.9rem">${formatDate(row._date)}</td>
                <td>
                    <div style="font-weight:600">${row.nombre_cliente}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">${row.celular_cliente}</div>
                </td>
                <td class="col-detalle">
                    ${detalleContent}
                </td>
                <td class="money">${formatMoney(row.total)}</td>
                <td style="text-align:center">
                     <a href="https://wa.me/549${String(row.celular_cliente).replace(/\D/g,'')}?text=${encodeURIComponent(mensajeCliente(row))}" 
                       target="_blank" class="btn-wa btn-wa-client" title="Contactar Cliente">
                       <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://wa.me/${telefonoNegocio}?text=${encodeURIComponent(mensajeWhatsApp(row))}" 
                       target="_blank" class="btn-wa btn-wa-support" title="Reportar Error">
                       <i class="fas fa-headset"></i>
                    </a>
                </td>
            `;
            el.tableBody.appendChild(tr);
        });

        renderPager();
    }

    function renderPager(){
        el.pager.innerHTML = '';
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        
        if(totalPages <= 1) return;

        const prevBtn = document.createElement('div');
        prevBtn.className = 'page-btn';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.onclick = () => { if(currentPage>1){ currentPage--; renderTable();} };
        el.pager.appendChild(prevBtn);

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        for(let i=startPage; i<=endPage; i++){
            const btn = document.createElement('div');
            btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => { currentPage = i; renderTable(); };
            el.pager.appendChild(btn);
        }

        const nextBtn = document.createElement('div');
        nextBtn.className = 'page-btn';
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.onclick = () => { if(currentPage<totalPages){ currentPage++; renderTable();} };
        el.pager.appendChild(nextBtn);
    }

    // --- MODAL FUNCTIONS (MODIFICADO PARA LISTA) ---
    window.openDetail = function(id) {
        const item = rawData.find(r => r.id == id);
        if(item) {
            el.modal.id.textContent = '#' + item.id;
            
            // Lógica para convertir texto plano a lista HTML
            let htmlContent = '';
            
            // 1. Separamos por el símbolo pipe |
            let items = item.detalle_compra.split('|');

            // 2. Si no hay pipes, intentamos separar por el patron "Numero x" (ej: 1x, 2x)
            if(items.length === 1 && items[0].match(/\d+x\s/)){
                 // Usamos regex para insertar un marcador de division antes de cada "Nx"
                 const tempStr = item.detalle_compra.replace(/(\d+x\s)/g, '|SPLIT|$1');
                 items = tempStr.split('|SPLIT|').filter(t => t.trim() !== '');
            }

            // 3. Generamos el HTML
            items.forEach(prod => {
                let txt = prod.trim();
                if(txt) {
                     htmlContent += `<div class="modal-item">
                        <i class="fas fa-check-circle"></i>
                        <span>${txt}</span>
                     </div>`;
                }
            });

            el.modal.text.innerHTML = htmlContent;
            el.modal.overlay.style.display = 'flex';
        }
    }

    window.closeDetail = function() {
        el.modal.overlay.style.display = 'none';
    }

    // --- EVENTOS ---
    el.inputs.search.addEventListener('input', applyFilters);
    el.inputs.id.addEventListener('input', applyFilters);
    el.inputs.from.addEventListener('change', applyFilters);
    el.inputs.to.addEventListener('change', applyFilters);
    el.inputs.perPage.addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value);
        currentPage = 1;
        renderTable();
    });

    // Cerrar modal al hacer click afuera
    el.modal.overlay.addEventListener('click', (e) => {
        if(e.target === el.modal.overlay) closeDetail();
    });

    document.getElementById('refresh').addEventListener('click', fetchSheet);

    document.getElementById('themeToggle').addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const icon = document.querySelector('#themeToggle i');
        if(document.body.classList.contains('dark')){
            icon.classList.replace('fa-moon', 'fa-sun');
        } else {
            icon.classList.replace('fa-sun', 'fa-moon');
        }
    });

    document.getElementById('export').addEventListener('click', () => {
        if(!filteredData.length) return alert('No hay datos para exportar');
        const headers = ["ID","Fecha","Cliente","Celular","Detalle","Total"];
        const csvRows = [];
        csvRows.push(headers.join(","));
        
        filteredData.forEach(row => {
            const values = [
                row.id,
                `"${formatDate(row._date)}"`,
                `"${row.nombre_cliente.replace(/"/g, '""')}"`,
                row.celular_cliente,
                `"${row.detalle_compra.replace(/"/g, '""')}"`,
                row.total
            ];
            csvRows.push(values.join(","));
        });
        
        const blob = new Blob([csvRows.join("\n")], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Ventas_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
    });

    // INIT
    fetchSheet();
    // Auto-actualizar cada 60s (aumentado para no saturar)
    setInterval(fetchSheet, 60000);  

  </script>
</body>
</html>
