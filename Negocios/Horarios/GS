/**
 * Función principal que sirve la página web (PanelHorarios.html)
 */
function doGet(e) {
  // Si entras tú con el link terminado en ?modo=admin, ves el panel de control
  if (e.parameter.modo === 'admin') {
    return HtmlService.createTemplateFromFile('PanelHorarios')
      .evaluate()
      .setTitle('Gestión de Horarios | El Fresquito')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
  }

  // SIEMPRE que no haya parámetro (como cuando entra la tienda), devuelve JSON
  const datos = obtenerHorariosSheet();
  
  // Si obtenerHorariosSheet devolvió un error (string), lo metemos en un objeto
  const respuesta = Array.isArray(datos) ? datos : { error: datos };

  return ContentService.createTextOutput(JSON.stringify(respuesta))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Lee los horarios desde la pestaña "Horarios" del Google Sheet
 */
function obtenerHorariosSheet() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Horarios");
    
    if (!sheet) return "Error: No se encontró la pestaña llamada 'Horarios'. Asegúrate de que el nombre sea exacto.";
    
    const datos = sheet.getDataRange().getValues();
    const horarios = [];
    
    // Recorremos desde la fila 2 (índice 1) para saltar el encabezado
    for (let i = 1; i < datos.length; i++) {
      if (datos[i][0] === "") continue; // Ignora filas vacías
      
      horarios.push({
        dia: datos[i][0].toString(),
        m_inicio: limpiarFormatoHora(datos[i][1]),
        m_fin:    limpiarFormatoHora(datos[i][2]),
        t_inicio: limpiarFormatoHora(datos[i][3]),
        t_fin:    limpiarFormatoHora(datos[i][4]),
        cerrado:  datos[i][5].toString().toUpperCase() === "SI",
        motivo:   datos[i][6] ? datos[i][6].toString() : "" // Columna G
      });
    }
    return horarios;
  } catch (e) {
    return "Error en el servidor: " + e.message;
  }
}

/**
 * Recibe los datos del Panel y los escribe en el Sheet
 */
function actualizarHorariosDesdePanel(nuevosDatos) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Horarios");
    const datos = sheet.getDataRange().getValues();
    
    for (let filaNueva of nuevosDatos) {
      for (let i = 1; i < datos.length; i++) {
        // Buscamos coincidencia por nombre de día (Columna A)
        if (datos[i][0].toString().toLowerCase() === filaNueva.dia.toLowerCase()) {
          
          // Actualizamos el rango: Fila i+1, desde columna 2 hasta la 7 (6 columnas en total)
          sheet.getRange(i + 1, 2, 1, 6).setValues([[
            filaNueva.m_inicio, 
            filaNueva.m_fin, 
            filaNueva.t_inicio, 
            filaNueva.t_fin, 
            filaNueva.cerrado ? "SI" : "NO",
            filaNueva.motivo
          ]]);
        }
      }
    }
    return "✅ ¡Cambios guardados exitosamente en el Sheet!";
  } catch (e) {
    return "❌ Error al guardar: " + e.message;
  }
}

/**
 * Función auxiliar para que las horas se vean bien (HH:mm) y no como fechas largas
 */
function limpiarFormatoHora(valor) {
  if (!valor) return "";
  if (valor instanceof Date) {
    // Convierte objeto Date de Google a string "HH:mm"
    return Utilities.formatDate(valor, Session.getScriptTimeZone(), "HH:mm");
  }
  return valor.toString();
}
